upstream auth_service {
    server 127.0.0.1:8001;
}
upstream clubs_service {
    server 127.0.0.1:8002;
}
upstream matches_service {
    server 127.0.0.1:8003;
}
upstream scoring_service {
    server 127.0.0.1:8004;
}
upstream communication_service {
    server 127.0.0.1:8005;
}
upstream commerce_service {
    server 127.0.0.1:8006;
}

server {
    listen 80;
    server_name api.crickitup.com api-staging.crickitup.com;

    # Common proxy settings
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 60s;
    proxy_connect_timeout 10s;

    # Health check (routed to auth but all services have it)
    location /api/v1/health {
        proxy_pass http://auth_service;
    }

    # ---- Auth service (:8001) ----
    location /api/v1/auth {
        proxy_pass http://auth_service;
    }
    location /api/v1/registration {
        proxy_pass http://auth_service;
    }
    location /api/v1/profiles {
        proxy_pass http://auth_service;
    }
    location /api/v1/roles {
        proxy_pass http://auth_service;
    }
    location /api/v1/permissions {
        proxy_pass http://auth_service;
    }
    location /api/v1/user-permissions {
        proxy_pass http://auth_service;
    }
    location /api/v1/platform {
        proxy_pass http://auth_service;
    }
    location /api/v1/navigation {
        proxy_pass http://auth_service;
    }
    # Club-scoped auth routes (registrations, roles)
    location ~ ^/api/v1/clubs/[^/]+/registrations {
        proxy_pass http://auth_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/roles {
        proxy_pass http://auth_service;
    }

    # ---- Clubs service (:8002) ----
    location ~ ^/api/v1/clubs/[^/]+/members {
        proxy_pass http://clubs_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/teams {
        proxy_pass http://clubs_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/seasons {
        proxy_pass http://clubs_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/players {
        proxy_pass http://clubs_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/key-people {
        proxy_pass http://clubs_service;
    }
    location /api/v1/clubs {
        proxy_pass http://clubs_service;
    }

    # ---- Matches service (:8003) ----
    # Must come BEFORE scoring's match-scoped routes due to specificity
    location ~ ^/api/v1/clubs/[^/]+/matches$ {
        proxy_pass http://matches_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/availability {
        proxy_pass http://matches_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/fixture-types {
        proxy_pass http://matches_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/fixture-series {
        proxy_pass http://matches_service;
    }
    location /api/v1/fixtures {
        proxy_pass http://matches_service;
    }
    location /api/v1/fixture-types {
        proxy_pass http://matches_service;
    }

    # ---- Scoring service (:8004) ----
    location ~ ^/api/v1/matches/[^/]+/scorecard {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/matches/[^/]+/opposition {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/matches/[^/]+/innings {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/matches/[^/]+/home-player {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/matches/[^/]+/result {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/matches/[^/]+/lifecycle {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/matches/[^/]+/audit-log {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/matches/[^/]+/participation {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/matches/[^/]+/confirm {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/matches/[^/]+/withdrawal {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/matches/[^/]+/substitute {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/matches/[^/]+/finalize {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/matches/[^/]+/abandoned {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/matches/[^/]+/recommendation {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/matches/[^/]+/player-stats {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/matches/[^/]+/clear-selections {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/matches/[^/]+/selection-withdrawal {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/matches-for-scoring {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/match-statistics {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/deadline-alerts {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/team-selection-config {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/player-selection {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/simulation-status {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/reset-selections {
        proxy_pass http://scoring_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/recommend {
        proxy_pass http://scoring_service;
    }
    location /api/v1/innings {
        proxy_pass http://scoring_service;
    }
    location /api/v1/players {
        proxy_pass http://scoring_service;
    }
    location /api/v1/player-selection-overrides {
        proxy_pass http://scoring_service;
    }

    # ---- Communication service (:8005) ----
    location ~ ^/api/v1/clubs/[^/]+/channels {
        proxy_pass http://communication_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/announcements {
        proxy_pass http://communication_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/faqs {
        proxy_pass http://communication_service;
    }
    location /api/v1/channels {
        proxy_pass http://communication_service;
    }
    location /api/v1/messages {
        proxy_pass http://communication_service;
    }
    location /api/v1/polls {
        proxy_pass http://communication_service;
    }
    location /api/v1/poll-options {
        proxy_pass http://communication_service;
    }
    location /api/v1/users {
        proxy_pass http://communication_service;
    }
    location /api/v1/notifications {
        proxy_pass http://communication_service;
    }
    location /api/v1/reminders {
        proxy_pass http://communication_service;
    }
    location /api/v1/push-tokens {
        proxy_pass http://communication_service;
    }

    # ---- Commerce service (:8006) ----
    location ~ ^/api/v1/clubs/[^/]+/payments {
        proxy_pass http://commerce_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/fee-config {
        proxy_pass http://commerce_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/finance {
        proxy_pass http://commerce_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/player-payment {
        proxy_pass http://commerce_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/merchandise {
        proxy_pass http://commerce_service;
    }
    location ~ ^/api/v1/clubs/[^/]+/media {
        proxy_pass http://commerce_service;
    }
    location /api/v1/payments {
        proxy_pass http://commerce_service;
    }
    location /api/v1/merchandise {
        proxy_pass http://commerce_service;
    }
    location /api/v1/media {
        proxy_pass http://commerce_service;
    }

    # Default: return 404 for unmatched API routes
    location /api/ {
        return 404;
    }
}
